var map,neighborhood,model={loadMap:function(){function e(e,a){if(a==google.maps.places.PlacesServiceStatus.OK)for(var t=[],n=0;n<e.length;n++){t.push(e[n].place_id);var r={placeId:t[n]};o.getDetails(r,function(e,a){a==google.maps.places.PlacesServiceStatus.OK&&(vm.placesDetails.push(e),vm.createMarker(e))})}}neighborhood=ko.computed(function(){return new google.maps.LatLng(vm.lat(),vm.lng())}),map=ko.observable(new google.maps.Map(document.getElementById("mapCanvas"),{center:neighborhood(),zoom:17}));var a={location:neighborhood(),radius:"200",types:["restaurant"]},o=new google.maps.places.PlacesService(map());o.nearbySearch(a,e)},loadYelp:function(){function e(){return Math.floor(1e12*Math.random()).toString()}var a="d6BWoZe6uqqYl5xoytRWJA",o="rEZQsiP5WA_f8kBFCtifxFPzkdU",t="8PJWa3DOZn0aM4uWY8iL18f9fhV3P1D2",n="Yu5I-EbDtktQmOBHKhJtLnc9_gc",r="http://api.yelp.com/v2/search",s={oauth_consumer_key:a,oauth_token:t,oauth_nonce:e(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",location:"New York",term:"food",limit:3},i=oauthSignature.generate("GET",r,s,o,n);s.oauth_signature=i;var l={url:r,data:s,cache:!0,dataType:"jsonp",success:function(e){console.log(e)},error:function(){console.log("paso algo")}};$.ajax(l)}},ViewModel=function(){var e=this;e.lat=ko.observable(40.8621822),e.lng=ko.observable(-73.8935974),e.init=function(){var e=document.createElement("script");$(e).attr("type","text/javascript"),e.onerror=function(e){alert(e)},e.src="https://maps.googleapis.com/maps/api/js?libraries=places&signed_in=true&key=AIzaSyD-ea-0b-EOXWC6svLpOyxcBKs3ecfe1co&callback=model.loadMap",$("body").append(e)},e.placesDetails=ko.observableArray([]),e.markers=ko.observableArray([]),e.query=ko.observable(""),e.search=ko.computed(function(){return ko.utils.arrayFilter(e.markers(),function(a){return a.title.toLowerCase().indexOf(e.query().toLowerCase())>=0})}),e.search.subscribe(function(){e.setMarkers()}),e.createMarker=function(a){function o(){for(var e="",a=0;a<r.length;a++)e+="<li><span><em>"+r[a].author_name+"</em> - </span>"+r[a].text+"<br/><span>Rating: </span>"+r[a].rating+"/5</li><br/>";return e}var t=a.geometry.location,n=new google.maps.Marker({map:map(),position:t,draggable:!0,animation:google.maps.Animation.DROP,title:a.name}),r=a.reviews?a.reviews:[{text:"No review availables"}],s=a.photos?'<img class="img-responsive center-block" src="'+a.photos[0].getUrl({maxWidth:200,maxHeight:200})+'" alt="location photo"><br/>':"<p>Not photos availables</p>",i=a.formatted_phone_number?"<p><span>Phone: </span>"+a.formatted_phone_number+"</p>":"<p><span>Phone: </span>Not Available</p>",l=a.formatted_address?"<p><span>Address: </span>"+a.formatted_address+"</p>":"<p><span>Address: </span>Not Available</p>",p="<h5>Reviews:</h5><ul>"+o()+"</ul>";n.info=new google.maps.InfoWindow({content:'<div class="infowindow"><h4 class="text-center">'+a.name+"</h4>"+s+l+i+p+"</div>"}),google.maps.event.addListener(n,"click",function(){n.info.open(map(),n)}),e.markers.push(n)},e.deleteMarkers=function(){for(var a=0;a<e.markers().length;a++)e.markers()[a].setMap(null)},e.setMarkers=function(){e.deleteMarkers();for(var a=0;a<e.search().length;a++)e.search()[a].setMap(map())},e.highlightMarker=function(e,a){console.log(e),e.setAnimation(null!=e.getAnimation()?null:google.maps.Animation.BOUNCE),window.setTimeout(function(){e.setAnimation(null)},7e3),e.info.open(map(),e)},e.init()},vm=new ViewModel;ko.applyBindings(vm);