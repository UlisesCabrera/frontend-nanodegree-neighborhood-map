var map,neighborhood;window.setTimeout(function(){"object"==typeof google&&"object"==typeof google.maps?console.log("google map is loaded"):$("#mapCanvas").html('<div class="map-error"><img class="img-responsive center-block error-img-big" src="images/error-big.jpg" alt="error image"><h3 class="text-center">oops something went wrong with google Maps</h3></div>')},5e3);var model={loadMap:function(){function e(e,o){if(o==google.maps.places.PlacesServiceStatus.OK)for(var a=[],i=e.length,t=0;i>t;t++){a.push(e[t].place_id);var n={placeId:a[t]};r.getDetails(n,function(e,o){o==google.maps.places.PlacesServiceStatus.OK&&vm.createMarker(e)})}}neighborhood=ko.computed(function(){return new google.maps.LatLng(vm.lat(),vm.lng())}),map=ko.observable(new google.maps.Map(document.getElementById("mapCanvas"),{center:neighborhood(),zoom:17,styles:[{featureType:"road",elementType:"labels.text",stylers:[{visibility:"simplified"},{hue:"#ff1100"},{color:"#ff0c59"},{weight:.3},{lightness:-79},{gamma:1.13}]},{featureType:"landscape.man_made",elementType:"geometry",stylers:[{visibility:"simplified"},{color:"#e8edf6"},{lightness:-21},{gamma:6.98}]},{featureType:"road.highway",stylers:[{visibility:"simplified"},{color:"#433540"},{lightness:71}]},{featureType:"road.local",stylers:[{visibility:"simplified"},{color:"#8659b8"},{gamma:5.3},{lightness:37}]},{featureType:"poi.park",stylers:[{visibility:"simplified"},{color:"#b5d1d8"},{lightness:23}]},{}]}));var o={location:neighborhood(),radius:"200",types:vm.typesOfPlaces()},r=new google.maps.places.PlacesService(map());r.nearbySearch(o,e)},loadYelp:function(e){function o(){return Math.floor(1e12*Math.random()).toString()}var r="d6BWoZe6uqqYl5xoytRWJA",a="rEZQsiP5WA_f8kBFCtifxFPzkdU",i="8PJWa3DOZn0aM4uWY8iL18f9fhV3P1D2",t="Yu5I-EbDtktQmOBHKhJtLnc9_gc",n="http://api.yelp.com/v2/phone_search",s={oauth_consumer_key:r,oauth_token:i,oauth_nonce:o(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",phone:e,limit:1},l=oauthSignature.generate("GET",n,s,a,t);s.oauth_signature=l;var c={url:n,data:s,cache:!0,dataType:"jsonp",timeout:1e3};$.ajax(c).done(function(e){$("#yelp .more-info-error").length>0&&($("#yelp .more-info-error").hide(),$("#yelp .innerWrapper").show()),vm.YelpDetails(e.businesses[0])}).fail(function(){0===$("#yelp .more-info-error").length?($("#yelp .innerWrapper").hide(),$("#yelp").append('<div class="more-info-error"><img class="error-img img-responsive center-block" src="images/error.jpg" alt="error image"><h3 class="text-center">oops something went wrong with YELP</h3></div>')):($("#yelp .innerWrapper").hide(),$("#yelp .more-info-error").show())})},loadFlickr:function(e,o){var r="https://api.flickr.com/services/rest/?&method=flickr.places.findByLatLon&api_key=44ff9d6c0d23eb0ed9189437f0bf1da2&jsoncallback=?",a="https://api.flickr.com/services/rest/?&method=flickr.photos.search&api_key=44ff9d6c0d23eb0ed9189437f0bf1da2&jsoncallback=?";$.getJSON(r,{lat:e,lon:o,accuracy:16,format:"json"}).done(function(e){var o=e.places.place[0].place_id;$.getJSON(a,{format:"json",place_id:o,privacy_filter:1,accuracy:16,content_type:1,per_page:25}).done(function(e){$("#flickr .more-info-error").length>0&&($("#flickr .more-info-error").hide(),$("#flickr .innerWrapper").show()),vm.flickrPhotos.removeAll();for(var o=e.photos.photo,r=0;r<o.length;r++){var a=o[r].farm,i=o[r].server,t=o[r].id,n=o[r].secret,s="https://farm"+a+".staticflickr.com/"+i+"/"+t+"_"+n+"_m.jpg)";vm.flickrPhotos.push(s)}}).fail(function(){0===$("#flickr .more-info-error").length?($("#flickr .innerWrapper").hide(),$("#flickr").append('<div class="more-info-error"><img class="error-img img-responsive center-block" src="images/error.jpg" alt="error image"><h3 class="text-center">oops something went wrong with Flickr</h3></div>')):($("#flickr .innerWrapper").hide(),$("#flickr .more-info-error").show())})}).fail(function(){0===$("#flickr .more-info-error").length?($("#flickr .innerWrapper").hide(),$("#flickr").append('<div class="more-info-error"><img class="error-img img-responsive center-block" src="images/error.jpg" alt="error image"><h3 class="text-center">oops something went wrong with Flickr</h3></div>')):($("#flickr .innerWrapper").hide(),$("#flickr .more-info-error").show())})}},ViewModel=function(){var e=this;e.lat=ko.observable(40.8621822),e.lng=ko.observable(-73.8935974),e.typesOfPlaces=ko.observableArray(["restaurant"]),e.init=function(){var e=document.createElement("script");e.src="https://maps.googleapis.com/maps/api/js?libraries=places&signed_in=true&key=AIzaSyD-ea-0b-EOXWC6svLpOyxcBKs3ecfe1co&callback=model.loadMap",$("body").append(e)},e.markers=ko.observableArray(),e.query=ko.observable(""),e.search=ko.computed(function(){return ko.utils.arrayFilter(e.markers(),function(o){return o.title.toLowerCase().indexOf(e.query().toLowerCase())>=0})}),e.search.subscribe(function(){e.setMarkers()}),e.createMarker=function(o){function r(){for(var e="",o=t.length,r=0;o>r;r++)e+="<li><span><em>"+t[r].author_name+"</em> - </span>"+t[r].text+"<br/><span>Rating: </span>"+t[r].rating+"/5</li><br/>";return e}var a=o.geometry.location,i=new google.maps.Marker({map:map(),position:a,draggable:!0,animation:google.maps.Animation.DROP,title:o.name,icon:"images/map-marker.png"}),t=o.reviews?o.reviews:[{text:"No review availables"}],n=o.photos?'<img class="img-responsive center-block" src="'+o.photos[0].getUrl({maxWidth:200,maxHeight:200})+'" alt="location photo"><br/>':"<p>Not photos availables</p>",s=o.formatted_phone_number?"<p><span>Phone: </span>"+o.formatted_phone_number+"</p>":"<p><span>Phone: </span>Not Available</p>",l=o.formatted_address?"<p><span>Address: </span>"+o.formatted_address+"</p>":"<p><span>Address: </span>Not Available</p>",c="<h5>Reviews:</h5><ul>"+r()+"</ul>";i.phone=o.formatted_phone_number,i.lat=o.geometry.location.G,i.lon=o.geometry.location.K,i.info=new google.maps.InfoWindow({content:'<div class="infowindow"><h4 class="text-center">'+o.name+"</h4>"+n+l+s+c+"</div>"}),google.maps.event.addDomListener(i.info,"closeclick",function(){closeMoreInfoToggler()}),google.maps.event.addListener(i,"click",function(){for(var o=e.markers().length,r=0;o>r;r++)e.markers()[r].info.close();i.info.open(map(),i),model.loadYelp(i.phone),model.loadFlickr(i.lat,i.lon),moreInfoToggler()}),e.markers.push(i)},e.deleteMarkers=function(){for(var o=e.markers().length,r=0;o>r;r++)e.markers()[r].setMap(null)},e.setMarkers=function(){e.deleteMarkers();for(var o=e.search().length,r=0;o>r;r++)e.search()[r].setMap(map())},e.highlightMarker=function(o,r){if(o.setAnimation(null!=o.getAnimation()?null:google.maps.Animation.BOUNCE),window.setTimeout(function(){o.setAnimation(null)},7e3),$(window).width()>=450){for(var a=e.markers().length,i=0;a>i;i++)e.markers()[i].info.close();o.info.open(map(),o)}model.loadYelp(o.phone),model.loadFlickr(o.lat,o.lon)},e.YelpDetails=ko.observable(),e.flickrPhotos=ko.observableArray(),e.init()},vm=new ViewModel;ko.applyBindings(vm);